name: Build prebuilt idol

on:
  push:
    #tags: ['v*.*.*']
    branches: [ "MacOSX", "!gh-pages" ]

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      IDOL_VERSION: ${{ github.ref_name }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure & Build
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$PWD/install
          make -j$(sysctl -n hw.ncpu)

      - name: Install
        run: cd build && make install

      - name: Package prebuilt tarball
        run: |
          cd build/install
          tar czf ../../idol-${IDOL_VERSION}-macos.tar.gz bin lib include
          cd ../..
          ls -l idol-${IDOL_VERSION}-macos.tar.gz

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: idol-${{ github.ref_name }}-macos.tar.gz
          body: "Prebuilt idol ${env.IDOL_VERSION} for macOS"
          files: idol-${{ github.ref_name }}-macos.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Formula
        env:
          TAP_REPO: hlefebvr/homebrew-idol
          TAP_BRANCH: main
        run: |
          # Clone tap repo
          git clone https://x-access-token:${{ secrets.HOMEBREW_PAT }}@github.com/hlefebvr/homebrew-idol.git tap
          cd tap

          # Compute SHA256 of the new tarball
          curl -L -o idol-${IDOL_VERSION}-macos.tar.gz \
               https://github.com/hlefebvr/idol/releases/download/${IDOL_VERSION}/idol-${IDOL_VERSION}-macos.tar.gz
          sha=$(shasum -a 256 idol-${IDOL_VERSION}-macos.tar.gz | awk '{print $1}')

          # Update idol.rb formula
          formula="Formula/idol.rb"
          sed -i '' -E "/on_macos do/,/end/ s|url \".*\"|url \"https://github.com/hlefebvr/idol/releases/download/${IDOL_VERSION}/${MACOS_TARBALL}\"|" Formula/idol.rb
          sed -i '' -E "/on_macos do/,/end/ s|sha256 \".*\"|sha256 \"${MACOS_SHA}\"|" Formula/idol.rb  

          # Commit & push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $formula
          git commit -m "Update formula for ${IDOL_VERSION}"
          git push origin $TAP_BRANCH